@use '../../styles/variables.scss' as *;
.tour-page-container {
  // min-height: 100vh;
  background-color: #f8f9fa;
}

// .filter-sidebar {
//   position: sticky;
//   top: 20px;
//   max-height: calc(100vh - 40px);
//   overflow-y: auto;
// }

.filter-section {
  border-bottom: 1px solid #e9ecef;
  padding-bottom: 1rem;

  &:last-child {
    border-bottom: none;
  }
}

.filter-title {
  font-weight: 600;
  color: $text-color;
  margin-bottom: 1rem;
  user-select: none;
  transition: color 0.2s;

  &:hover {
    color: $primary-color;
  }

  .fa {
    transition: transform 0.3s ease;
    font-size: 0.875rem;
    color: $text-color;
  }
}

.filter-options,
.price-range {
  padding-right: 0.5rem;
  max-height: 1000px;
  overflow: hidden;
  transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
  opacity: 1;

  &.collapsed {
    max-height: 0;
    opacity: 0;
    padding-top: 0;
    padding-bottom: 0;
    margin: 0;
  }
}

.form-check {
  padding-left: 1.75rem;
}

.form-check-input {
  margin-top: 0.35rem;
  cursor: pointer;
}

.form-check-label {
  cursor: pointer;
  font-size: 0.9rem;
  color: $text-color;
  transition: color 0.2s;

  &:hover {
    color: $primary-color;
  }
}

.price-range {
  .range-slider {
    input[type="range"] {
      width: 100%;
      cursor: pointer;
    }
  }
}

.btn-group {
  .btn.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
  }
}

// Tour cards grid/list layout
// .row.g-4,
// .row.g-3 {
//   .col-lg-4,
//   .col-md-6,
//   .col-12 {
//     margin-bottom: 1rem;
//   }
// }

// Empty state
.text-center {
  .fa-search {
    opacity: 0.3;
  }
}

// Sidebar overlay for mobile
.sidebar-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  z-index: 1040;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;

  &.active {
    opacity: 1;
    pointer-events: all;
  }
}

// Sidebar wrapper
.filter-sidebar-wrapper {
  transition: transform 0.3s ease;
}

// .filter-sidebar {
//   position: sticky;
//   top: 20px;
//   max-height: calc(100vh - 40px);
//   overflow-y: auto;
// }

.sidebar-close-btn {
  display: none;
}

// Responsive adjustments
@media (max-width: 991.98px) {
  .sidebar-overlay {
    display: block;
  }

  .filter-sidebar-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 320px;
    max-width: 85vw;
    height: 100vh;
    z-index: 1050;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    padding: 0;
    margin: 0;
    background-color: #fff;
    box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);

    &.sidebar-open {
      transform: translateX(0);
    }
  }

  .filter-sidebar {
    position: relative;
    top: 0;
    max-height: 100vh;
    height: 100%;
    border-radius: 0;
    overflow-y: auto;
    padding: 1.5rem;
  }

  .sidebar-close-btn {
    display: block;
  }
}

@media (max-width: 768px) {
  .filter-sidebar-wrapper {
    width: 300px;
    max-width: 80vw;
  }

  .d-flex.justify-content-between {
    flex-direction: column;
    gap: 1rem;
    align-items: flex-start !important;
  }
}


/*

import { Component, OnInit, Inject, PLATFORM_ID, ChangeDetectorRef } from '@angular/core';
import { isPlatformBrowser, CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { SeoService } from '../../services/seo.service';
import { ActivatedRoute, Router } from '@angular/router';
import { ICategory } from '../../core/interfaces/icategory';
import { IDestination } from '../../core/interfaces/idestination';
import { IDuration } from '../../core/interfaces/iduration';
import { Category, Destination, Itour } from '../../core/interfaces/itour';
import { DataService } from '../../services/data.service';
import { TourCartComponent } from '../../shared/components/tour-cart/tour-cart.component';

@Component({
  selector: 'app-tour',
  standalone: true,
  imports: [TourCartComponent, CommonModule, FormsModule],
  templateUrl: './tour.component.html',
  styleUrl: './tour.component.scss',
})
export class TourComponent implements OnInit {
  isBrowser: boolean;

  constructor(
    private seoService: SeoService,
    private _ActivatedRoute: ActivatedRoute,
    private _DataService: DataService,
    private _Router: Router,
    private _cdr: ChangeDetectorRef,
    @Inject(PLATFORM_ID) private platformId: Object
  ) {
    this.isBrowser = isPlatformBrowser(platformId);
  }

  // Helper method to get data from localStorage
  private getFromLocalStorage(key: string): any | null {
    if (!this.isBrowser) {
      return null;
    }
    try {
      const item = localStorage.getItem(key);
      return item ? JSON.parse(item) : null;
    } catch (error) {
      console.warn(`Error reading from localStorage for key ${key}:`, error);
      return null;
    }
  }

  layoutType: 'grid' | 'list' = 'grid';
  isLoading: boolean = false;
  sidebarOpen: boolean = false;
  openFilterSection: string = 'destinations'; // Default: first item is open

  selectedDestinationSlug: string | null = null;
  selectedCategorySlug: string | null = null;
  selectedDurationSlug: string | null = null;

  // Track if "Select All" is active for each filter
  isSelectAllDestinations: boolean = false;
  isSelectAllCategories: boolean = false;
  isSelectAllDurations: boolean = false;

  allCategories: ICategory[] = [];
  allDestinations: IDestination[] = [];
  allDurations: IDuration[] = [];
  allTours: Itour[] = [];

  // Ensure arrays are always arrays (safety getters)
  get safeCategories(): ICategory[] {
    return Array.isArray(this.allCategories) ? this.allCategories : [];
  }

  get safeDestinations(): IDestination[] {
    return Array.isArray(this.allDestinations) ? this.allDestinations : [];
  }

  get safeDurations(): IDuration[] {
    return Array.isArray(this.allDurations) ? this.allDurations : [];
  }
  totalItems: number = 0;
  currentPage: number = 1;
  filteredTours: Itour[] = [];
  minBudget: number = 0;
  maxBudget: number = 5000;

  ngOnInit(): void {
    this.seoService.updateSeoData(
      {},
      'Majestic Egyption Experience - Tours',
      'Search and discover amazing tours with Majestic Egyption Experience. Your trusted travel partner for premium tours and exceptional travel experiences.',
      '../../../assets/image/majestic-logo.svg'
    );

    // Load destinations, categories, and durations
    this.getDestinations();
    this.getCategories();
    this.getDurations();
    this.getTours();

    this._ActivatedRoute.queryParams.subscribe((param) => {
      console.log('Query params changed:', param);

      // Use slugs directly from query params
      // Only set if param exists, otherwise keep null (no filter = Select All)
      this.selectedDestinationSlug = param['location'] || null;
      this.selectedCategorySlug = param['type'] || null;
      this.selectedDurationSlug = param['duration'] || null;

      // Update price range from query params if present
      if (param['minPrice']) {
        this.minBudget = Number(param['minPrice']) || 0;
      } else {
        this.minBudget = 0; // Reset to default if not in query
      }
      if (param['maxPrice']) {
        this.maxBudget = Number(param['maxPrice']) || 5000;
      } else {
        this.maxBudget = 5000; // Reset to default if not in query
      }

      this.filterTours();
    });
  }

  getDestinations(): void {
    const cachedDestinations = this.getFromLocalStorage('majestic_destinations');
    if (cachedDestinations?.data?.data) {
      setTimeout(() => {
        this.allDestinations = cachedDestinations.data.data;
        this._cdr.markForCheck();
      }, 0);
    } else {
      this._DataService.getDestination().subscribe({
        next: (res) => {
          setTimeout(() => {
            if (res?.data?.data) {
              this.allDestinations = res.data.data;
            }
            this._cdr.markForCheck();
          }, 0);
        },
        error: (err) => {
          console.error('Error loading destinations:', err);
        },
      });
    }
  }

  getCategories(): void {
    const cachedCategories = this.getFromLocalStorage('majestic_categories');
    if (cachedCategories?.data?.data && Array.isArray(cachedCategories.data.data)) {
      setTimeout(() => {
        this.allCategories = cachedCategories.data.data;
        this._cdr.markForCheck();
      }, 0);
    } else {
      this._DataService.getCategory().subscribe({
        next: (res) => {
          setTimeout(() => {
            if (res?.data?.data && Array.isArray(res.data.data)) {
              this.allCategories = res.data.data;
            } else {
              // Fallback: ensure it's always an array
              this.allCategories = [];
            }
            this._cdr.markForCheck();
          }, 0);
        },
        error: (err) => {
          console.error('Error loading categories:', err);
          setTimeout(() => {
            this.allCategories = [];
            this._cdr.markForCheck();
          }, 0);
        },
      });
    }
  }

  getDurations(): void {
    const cachedDurations = this.getFromLocalStorage('majestic_durations');
    // Durations might be stored directly as array or nested in data.data
    if (cachedDurations?.data) {
      setTimeout(() => {
        // Check if it's an array directly or nested
        if (Array.isArray(cachedDurations.data)) {
          this.allDurations = cachedDurations.data;
        } else if (Array.isArray(cachedDurations.data.data)) {
          this.allDurations = cachedDurations.data.data;
        } else {
          this.allDurations = [];
        }
        this._cdr.markForCheck();
      }, 0);
    } else {
      this._DataService.getDurations().subscribe({
        next: (res) => {
          setTimeout(() => {
            // Check if it's an array directly or nested
            if (Array.isArray(res?.data)) {
              this.allDurations = res.data;
            } else if (Array.isArray(res?.data?.data)) {
              this.allDurations = res.data.data;
            } else {
              this.allDurations = [];
            }
            this._cdr.markForCheck();
          }, 0);
        },
        error: (err) => {
          console.error('Error loading durations:', err);
          setTimeout(() => {
            this.allDurations = [];
            this._cdr.markForCheck();
          }, 0);
        },
      });
    }
  }

  getTours(): void {
    this.isLoading = true;
    this._DataService.getTours().subscribe({
      next: (res) => {
        setTimeout(() => {
          if (res?.data?.data) {
            this.allTours = res.data.data;
            console.log('âœ… Tours loaded:', this.allTours.length);

            // Apply filters after tours are loaded
            this.filterTours();
          } else {
            console.warn('âš ï¸ No tours data in response:', res);
            this.isLoading = false;
          }
          this._cdr.markForCheck();
        }, 0);
      },
      error: (err) => {
        console.error('âŒ Error loading tours:', err);
        setTimeout(() => {
          this.isLoading = false;
          this._cdr.markForCheck();
        }, 0);
      },
    });
  }

  filterTours() {
    this.isLoading = true;

    // Use client-side filtering instead of API calls for better performance
    let filtered = [...this.allTours];

    console.log('ðŸ” Starting filter with:', {
      totalTours: this.allTours.length,
      destinationSlug: this.selectedDestinationSlug,
      categorySlug: this.selectedCategorySlug,
      durationSlug: this.selectedDurationSlug,
    });

    // Filter by selected destination slug or Select All
    if (this.isSelectAllDestinations) {
      // Select All: Show all tours that have at least one destination
      const beforeCount = filtered.length;
      filtered = filtered.filter((tour) => {
        return (
          tour.destinations && Array.isArray(tour.destinations) && tour.destinations.length > 0
        );
      });
      console.log(`ðŸ“ After Select All Destinations: ${beforeCount} â†’ ${filtered.length}`);
    } else if (this.selectedDestinationSlug) {
      const beforeCount = filtered.length;
      console.log(`ðŸ” Filtering by destination slug: "${this.selectedDestinationSlug}"`);

      filtered = filtered.filter((tour) => {
        if (!tour.destinations || !Array.isArray(tour.destinations)) {
          return false;
        }
        const matches = tour.destinations.some(
          (dest: Destination) => dest.slug === this.selectedDestinationSlug
        );
        return matches;
      });
      console.log(
        `ðŸ“ After destination filter (${this.selectedDestinationSlug}): ${beforeCount} â†’ ${filtered.length}`
      );
    }

    // Filter by selected category slug or Select All
    if (this.isSelectAllCategories) {
      // Select All: Show all tours that have at least one category
      const beforeCount = filtered.length;
      filtered = filtered.filter((tour) => {
        return tour.categories && Array.isArray(tour.categories) && tour.categories.length > 0;
      });
      console.log(`ðŸ·ï¸ After Select All Categories: ${beforeCount} â†’ ${filtered.length}`);
    } else if (this.selectedCategorySlug) {
      const beforeCount = filtered.length;
      filtered = filtered.filter((tour) => {
        if (!tour.categories || !Array.isArray(tour.categories)) {
          return false;
        }
        const matches = tour.categories.some(
          (cat: Category) => cat.slug === this.selectedCategorySlug
        );
        return matches;
      });
      console.log(
        `ðŸ·ï¸ After category filter (${this.selectedCategorySlug}): ${beforeCount} â†’ ${filtered.length}`
      );
    }

    // Filter by selected duration slug or Select All
    if (this.isSelectAllDurations) {
      // Select All: Show all tours that have a duration
      const beforeCount = filtered.length;
      filtered = filtered.filter((tour) => {
        return tour.duration && tour.duration.length > 0;
      });
      console.log(`â±ï¸ After Select All Durations: ${beforeCount} â†’ ${filtered.length}`);
    } else if (this.selectedDurationSlug) {
      const beforeCount = filtered.length;
      filtered = filtered.filter((tour) => {
        // Check if tour.duration (string) matches the slug
        if (tour.duration) {
          return tour.duration === this.selectedDurationSlug;
        }
        return false;
      });
      console.log(
        `â±ï¸ After duration filter (${this.selectedDurationSlug}): ${beforeCount} â†’ ${filtered.length}`
      );
    }

    // Filter by price range (only if budget range is set)
    if (this.minBudget > 0 || this.maxBudget > 0) {
      const beforeCount = filtered.length;
      filtered = filtered.filter((tour) => {
        let price = 0;
        if (tour.start_from) {
          price = Number(tour.start_from);
        } else if (tour.adult_price) {
          price = Number(tour.adult_price);
        }

        const inRange =
          price >= this.minBudget && (this.maxBudget === 0 || price <= this.maxBudget);
        return inRange;
      });
      console.log(
        `ðŸ’° After price filter (${this.minBudget}-${this.maxBudget}): ${beforeCount} â†’ ${filtered.length}`
      );
    }

    // Use setTimeout to defer update to next change detection cycle
    setTimeout(() => {
      this.filteredTours = filtered;
      this.totalItems = filtered.length;
      this.currentPage = 1; // Reset to first page when filters change

      console.log('=== âœ… FILTERING RESULTS ===');
      console.log('Selected destination slug:', this.selectedDestinationSlug);
      console.log('Selected category slug:', this.selectedCategorySlug);
      console.log('Selected duration slug:', this.selectedDurationSlug);
      console.log('Price range:', this.minBudget, '-', this.maxBudget);
      console.log('Total tours before filtering:', this.allTours.length);
      console.log('Total tours after filtering:', filtered.length);
      console.log('Filtered tours:', this.filteredTours);
      console.log('========================');

      // Hide loading after filtering is complete
      this.isLoading = false;
      this._cdr.markForCheck();
    }, 0);
  }

  onRadioChange(
    key: 'selectedCategorySlug' | 'selectedDurationSlug' | 'selectedDestinationSlug',
    value: string | null
  ) {
    // For radio, set the value directly (single selection)
    // Also clear Select All flag when individual option is selected
    if (key === 'selectedCategorySlug') {
      this.selectedCategorySlug = value;
      this.isSelectAllCategories = false; // Clear Select All when individual option is selected
    } else if (key === 'selectedDurationSlug') {
      this.selectedDurationSlug = value;
      this.isSelectAllDurations = false; // Clear Select All when individual option is selected
    } else if (key === 'selectedDestinationSlug') {
      this.selectedDestinationSlug = value;
      this.isSelectAllDestinations = false; // Clear Select All when individual option is selected
    }

    this.updateQueryParams();
    this.filterTours();
  }

  // Select all for destinations - selects all destinations that exist in filtered tours
  selectAllDestinations() {
    if (this.isSelectAllDestinations) {
      // If already selected, clear selection
      this.isSelectAllDestinations = false;
      this.selectedDestinationSlug = null;
    } else {
      // Get all unique destinations from filtered tours (or all tours if no filter)
      const toursToCheck = this.filteredTours.length > 0 ? this.filteredTours : this.allTours;
      const uniqueDestinations = new Set<string>();

      toursToCheck.forEach((tour) => {
        if (tour.destinations && Array.isArray(tour.destinations) && tour.destinations.length > 0) {
          tour.destinations.forEach((dest: Destination) => {
            if (dest.slug) {
              uniqueDestinations.add(dest.slug);
            }
          });
        }
      });

      // Set Select All as active
      this.isSelectAllDestinations = true;
      this.selectedDestinationSlug = null; // Clear single selection when Select All is active
    }
    this.updateQueryParams();
    this.filterTours();
  }

  // Select all for categories - selects all categories that exist in filtered tours
  selectAllCategories() {
    if (this.isSelectAllCategories) {
      // If already selected, clear selection
      this.isSelectAllCategories = false;
      this.selectedCategorySlug = null;
    } else {
      // Get all unique categories from filtered tours (or all tours if no filter)
      const toursToCheck = this.filteredTours.length > 0 ? this.filteredTours : this.allTours;
      const uniqueCategories = new Set<string>();

      toursToCheck.forEach((tour) => {
        if (tour.categories && Array.isArray(tour.categories) && tour.categories.length > 0) {
          tour.categories.forEach((cat: Category) => {
            if (cat.slug) {
              uniqueCategories.add(cat.slug);
            }
          });
        }
      });

      // Set Select All as active
      this.isSelectAllCategories = true;
      this.selectedCategorySlug = null; // Clear single selection when Select All is active
    }
    this.updateQueryParams();
    this.filterTours();
  }

  // Select all for durations - selects all durations that exist in filtered tours
  selectAllDurations() {
    if (this.isSelectAllDurations) {
      // If already selected, clear selection
      this.isSelectAllDurations = false;
      this.selectedDurationSlug = null;
    } else {
      // Get all unique durations from filtered tours (or all tours if no filter)
      const toursToCheck = this.filteredTours.length > 0 ? this.filteredTours : this.allTours;
      const uniqueDurations = new Set<string>();

      toursToCheck.forEach((tour) => {
        if (tour.duration) {
          uniqueDurations.add(tour.duration);
        }
      });

      // Set Select All as active
      this.isSelectAllDurations = true;
      this.selectedDurationSlug = null; // Clear single selection when Select All is active
    }
    this.updateQueryParams();
    this.filterTours();
  }

  setLayout(type: 'grid' | 'list') {
    this.layoutType = type;
  }

  onPriceRangeChange() {
    this.updateQueryParams();
    this.filterTours();
  }

  // Method to clear all filters
  clearAllFilters() {
    this.selectedCategorySlug = null;
    this.selectedDestinationSlug = null;
    this.selectedDurationSlug = null;
    this.isSelectAllDestinations = false;
    this.isSelectAllCategories = false;
    this.isSelectAllDurations = false;
    this.minBudget = 0;
    this.maxBudget = 5000;
    this.updateQueryParams();
    this.filterTours();
  }

  removeAllDestinations() {
    this.selectedDestinationSlug = null;
    this.isSelectAllDestinations = false;
    this.updateQueryParams();
    this.filterTours();
  }

  removeAllCategories() {
    this.selectedCategorySlug = null;
    this.isSelectAllCategories = false;
    this.updateQueryParams();
    this.filterTours();
  }

  removeAllDurations() {
    this.selectedDurationSlug = null;
    this.isSelectAllDurations = false;
    this.updateQueryParams();
    this.filterTours();
  }

  removeAllPrices() {
    this.minBudget = 0;
    this.maxBudget = 5000;
    this.updateQueryParams();
    this.filterTours();
  }

  // Update URL query params based on current filter state
  updateQueryParams(): void {
    const queryParams: any = {};

    // Get current query params to preserve other params
    const currentParams = { ...this._ActivatedRoute.snapshot.queryParams };

    // Update location param
    if (this.selectedDestinationSlug) {
      queryParams['location'] = this.selectedDestinationSlug;
    } else {
      // Remove location param if it's null
      delete currentParams['location'];
    }

    // Update type param
    if (this.selectedCategorySlug) {
      queryParams['type'] = this.selectedCategorySlug;
    } else {
      // Remove type param if it's null
      delete currentParams['type'];
    }

    // Update duration param
    if (this.selectedDurationSlug) {
      queryParams['duration'] = this.selectedDurationSlug;
    } else {
      // Remove duration param if it's null
      delete currentParams['duration'];
    }

    // Update price range params
    if (this.minBudget > 0) {
      queryParams['minPrice'] = this.minBudget;
    } else {
      delete currentParams['minPrice'];
    }

    if (this.maxBudget < 5000) {
      queryParams['maxPrice'] = this.maxBudget;
    } else {
      delete currentParams['maxPrice'];
    }

    // Merge new params with existing ones (excluding removed ones)
    const finalParams = { ...currentParams, ...queryParams };

    // Update URL without reloading the page
    this._Router.navigate([], {
      relativeTo: this._ActivatedRoute,
      queryParams: finalParams,
      replaceUrl: true, // Replace current history entry (don't create new history entry)
    });
  }

  // sort
  onSortChange(event: Event) {
    const sortBy = (event.target as HTMLSelectElement).value;

    switch (sortBy) {
      case 'recent':
        this.sortByRecent();
        break;
      // to do best seller , you must have property to check number of seller si 'sales_count'
      // i use display_order [true or false]
      case 'bestseller':
        this.sortByBestSeller();
        break;
      case 'price-low-high':
        this.sortByPriceAsc();
        break;
      case 'price-high-low':
        this.sortByPriceDesc();
        break;
      default:
        break;
    }
  }

  sortByBestSeller() {
    this.filteredTours = [...this.allTours].sort((a, b) => b.display_order - a.display_order);
    // console.log(this.filteredTours);
  }

  sortByRecent() {
    this.filteredTours = [...this.allTours].sort((a, b) => b.id - a.id);
    // console.log(this.filteredTours);
  }

  sortByPriceAsc() {
    this.filteredTours = [...this.allTours].sort((a, b) => a.start_from - b.start_from);
    // console.log(this.filteredTours);
  }

  sortByPriceDesc() {
    this.filteredTours = [...this.allTours].sort((a, b) => b.start_from - a.start_from);
    // console.log(this.filteredTours);
  }

  toggleSidebar() {
    this.sidebarOpen = !this.sidebarOpen;
  }

  closeSidebar() {
    this.sidebarOpen = false;
  }

  toggleFilterSection(section: string) {
    // If clicking the same section, close it; otherwise open the clicked section
    if (this.openFilterSection === section) {
      this.openFilterSection = '';
    } else {
      this.openFilterSection = section;
    }
  }

  isFilterSectionOpen(section: string): boolean {
    return this.openFilterSection === section;
  }
}



 */
